<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="theme-color" content="#ffffff" />

	<title>Pooiod7's Scratch project extension manager (wip)</title>

	<style>
        .loader-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            transition: opacity 0.5s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
        }
        .loader {
            display: block;
            --height-of-loader: 4px;
            --loader-color: #37ac00;
            width: 130px;
            height: var(--height-of-loader);
            border-radius: 30px;
            background-color: rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .loader::before {
            content: "";
            position: absolute;
            background: var(--loader-color);
            top: 0;
            left: 0;
            width: 0%;
            height: 100%;
            border-radius: 30px;
            animation: moving 1s ease-in-out infinite;
        }
        @keyframes moving {
            50% {
                width: 100%;
            }
            100% {
                width: 0;
                right: 0;
                left: unset;
            }
        }

		body, html {
			margin: 0;
			padding: 0;
			height: 100%;
			overflow: hidden;
			font-family: sans-serif;
			background: #f9f9f9;
			color: #111;
		}

		#container {
			display: flex;
			height: 100%;
			width: 100%;
			transition: all 0.5s ease;
		}

		#file-picker {
			margin: 0px;
			background: #eaeaea;
			border-top: 1px solid #ccc;
			/* border: 2px dashed #bbb; */
			display: flex;
			align-items: center;
			justify-content: center;
			width: 100%;
			height: 100%;
			position: relative;
			transition: opacity 0.5s ease, width 0.5s ease;
			background-size: contain;
			background-repeat: no-repeat;
			background-position: center;
		}
		#file-picker.dragover {
			background-color: #ddd;
		}
		#file-picker span {
			font-size: 1.5em;
			color: #666;
			transition: opacity 0.3s ease;
		}

		.scratchblockscontainer {
			width: 0;
			overflow: auto;
			background: #fff;
			color: #111;
			transition: width 0.5s ease;
			/* border-top: 1px solid #ccc; */
			/* max-width: 50vw; */
			padding: 0px;
			top: 0px;
			z-index: 1;
		}

		.scratchblockscontainer.visible {
			overflow: auto;
			width: 800px;
		}

		.scratchblockscontainer.outline {
			border-left: 1px solid #ccc;
		}

		.scratchblockscontainer::before {
			content: "";
			position: sticky;
			top: 0px;
			display: block;
			height: 100%;
			margin-top: calc(-100vh + 20px);
			pointer-events: none;
			background: linear-gradient(
				to bottom,
				white 0,
				transparent 20px,
				transparent calc(100% - 20px),
				white 100%
			);
		}

		#scratchblocks {
			overflow: hidden;
			margin: 20px;
			margin-bottom: 40px;
			zoom: 80%;
		}

		#hide-extension {
			position: fixed;
			top: 5px;
			right: 5px;
			z-index: 9999;

			padding: 10px;
			background: #eee;
			border: 1px solid #ccc;
			cursor: pointer;
			transition: background 0.3s, padding 0.3s, opacity 0.3s;
		}

		#hide-extension:hover {
			background: #ddd;
		}

		#menu {
			width: 0;
			opacity: 0;
			overflow: hidden;
			background: #fff;
			color: #111;
			transition: all 0.5s ease, border 0s;
			display: flex;
			flex-direction: column;
			z-index: 1;
		}
		#menu.visible {
			width: 350px !important;
			opacity: 1;
			padding: 10px 10px;
		}

		#menu.outline {
			border-left: 1px solid #ccc;
		}

		#menu h1 {
			font-size: 1.2em;
			margin: 0px;
			margin-bottom: 10px;
			margin-top: 10px;
			text-align: center;
		}

		#extensions-container {
			flex: 1;
			overflow-y: auto;
			margin-bottom: 10px;
			--container-height: 100%;
		}

		#extensions-container .ext-item:first-child {
			margin-top: 10px;
		}
		#extensions-container .ext-item:last-child {
			margin-bottom: 10px;
		}

		#extensions-container::before {
			content: "";
			display: block;
			position: sticky;

			top: 0;
			height: var(--container-height);
			margin-top: calc(var(--container-height) * -1);

			pointer-events: none;
			z-index: 999;

			background: linear-gradient(
				to bottom,
				white 0,
				transparent 10px,
				transparent calc(100% - 10px),
				white 100%
			);
		}

		.ext-item {
			width: 100%;
			margin-bottom: 5px;
		}
		.ext-button {
			width: 100%;
			padding: 10px;
			background: #eee;
			border: 1px solid #ccc;
			cursor: pointer;
			display: flex;
			justify-content: space-between;
			align-items: center;
			transition: background 0.3s;
		}
		.ext-button:hover {
			background: #ddd;
		}
		.ext-arrow {
			transition: transform 0.3s ease;
		}
		.ext-arrow.open {
			transform: rotate(90deg);
		}
		.ext-dropdown {
			max-height: 0;
			overflow: hidden;
			transition: max-height 0.3s ease;
		}
		.ext-dropdown.open {
			max-height: 300px;
			margin-bottom: 10px;
		}
		.ext-dropdown input {
			width: calc(100% - 12px);
			padding: 5px;
			margin: 5px 0;
			border: 1px solid #ccc;
			background: #f9f9f9;
		}
		.ext-dropdown button {
			width: 100%;
			padding: 5px;
			margin-bottom: 5px;
			border: 1px solid #ccc;
			background: #eee;
			cursor: pointer;
		}
		.ext-dropdown button:disabled {
			cursor: not-allowed;
			background: #ddd;
		}

		#project-buttons {
			display: flex;
			flex-direction: column;
		}
		#project-buttons button {
			width: 100%;
			padding: 10px;
			margin-top: 5px;
			border: 1px solid #ccc;
			background: #eee;
			cursor: pointer;
		}
		#project-buttons button:disabled {
			cursor: not-allowed;
			background: #ddd;
		}

		#add-extension-popup, #archive-popup {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(249,249,249,0.95);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 10;
		}

		#popup-content {
			background: #fff;
			border: 1px solid #ccc;
			width: 400px;
			max-width: 90%;
			padding: 20px;
			box-sizing: border-box;
		}

		#popup-tabs {
			display: flex;
			margin-bottom: 10px;
		}

		.tab-button {
			flex: 1;
			padding: 10px;
			background: #eee;
			border: 1px solid #ccc;
			cursor: pointer;
			text-align: center;
		}
		.tab-button.active {
			background: #ddd;
		}
		.tab-content {
			display: none;
		}
		.tab-content.active {
			display: block;
		}
		#popup-back, #popup-set, #archive-close, #archive-confirm {
			margin-top: 10px;
			width: 100%;
			padding: 10px;
			background: #eee;
			border: 1px solid #ccc;
			cursor: pointer;
		}
		.tab-content #ext-url-input {
			width: calc(100% - 6px);
		}

		textarea {
			width: 100%;
			height: 150px;
			resize: vertical;
			padding: 5px;
			border: 1px solid #ccc;
			box-sizing: border-box;
			background: #f9f9f9;
		}

		#archive-content {
			background: #fff;
			border: 1px solid #ccc;
			width: 300px;
			max-width: 90%;
			padding: 20px;
			box-sizing: border-box;
			text-align: center;
		}
		#archive-popup input[type="date"] {
			padding: 5px;
			width: calc(100% - 15px);
			margin-bottom: 10px;
		}

		.popup-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100vw;
			height: 100vh;
			background: rgba(249, 249, 249, 0.95);
			transition: opacity 0.5s ease;
			display: flex;
			justify-content: center;
			align-items: center;
			z-index: 9999;
		}

		.popup-content {
			background: white;
			border: 1px solid #ccc;
			transition: transform 0.3s ease, opacity 0.3s ease;
			padding: 20px;
			box-sizing: border-box;
			max-width: 500px;
			width: 100%;
		}

		.popup-content a {
			color: inherit;
		}

		.popup-content h2 {
			margin: 0 0 10px 0;
			font-size: 1.5em;
			color: #000;
		}

		.popup-content p {
			margin: 0 0 20px 0;
			color: #000;
		}

		.popup-button {
			width: calc(100% - 25px);
			padding: 10px;
			background: #eee;
			border: 1px solid #ccc;
			cursor: pointer;
			display: flex;
			justify-content: space-between;
			align-items: center;
			transition: background 0.3s;
		}

		.popup-button:hover {
			background: #ddd;
		}

		.spinner {
			border: 4px solid #f3f3f3;
			border-top: 4px solid #3498db;
			border-radius: 50%;
			width: 40px;
			height: 40px;
			animation: spin 2s linear infinite;
			margin: 10px auto;
		}

		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
			}
			to {
				opacity: 1;
			}
		}

		@media (max-width: 550px) {
			#menu.visible {
				width: 100vw !important;
			}
			#menu.outline {
				border: 0px !important;
			}

			.scratchblockscontainer.visible {
				max-width: 100vw;
				width: 100vw !important;
			}
			.scratchblockscontainer.outline {
				border-left: 0px;
			}

			#file-picker.picked {
				width: 0px;
			}
			#file-picker {
				border: 0px !important;
			}
		}
	</style>
</head>
<body>
    <div class="loader-wrapper" id="loader">
        <div class="loader"></div>
    </div>

	<button id="hide-extension" style="display: none;">Hide viewer</button>

	<div id="container">
		<div id="file-picker"><span>Load a Scratch project</span></div>
		<div class="scratchblockscontainer" id="scratchblockscontainer"><div id="scratchblocks"></div></div>

		<div id="menu" class="outline">
			<h1></h1>
			<div id="extensions-container"></div>

			<div id="project-buttons">
				<button id="save-project">Save project</button>
				<button id="load-project">Load project</button>
				<button id="add-extension">Add extension</button>
			</div>
		</div>
	</div>

	<div id="add-extension-popup">
		<div id="popup-content">
			<div id="popup-tabs">
				<div class="tab-button active" data-tab="url-tab">URL</div>
				<div class="tab-button" data-tab="file-tab">File</div>
				<div class="tab-button" data-tab="code-tab">Code</div>
			</div>

			<div id="url-tab" class="tab-content active">
				<input type="text" id="ext-url-input" placeholder="Enter extension URL">
				<button id="ext-url-set" style="display: none;">Set</button>
			</div>

			<div id="file-tab" class="tab-content">
				<input type="file" id="ext-file-input" accept=".js">
			</div>

			<div id="code-tab" class="tab-content">
				<textarea id="ext-code-input" placeholder="Paste JS code here"></textarea>
				<button id="ext-code-set" style="display: none;">Set</button>
			</div>

			<button id="popup-set">Add Extension</button>
			<button id="popup-back">Back</button>
		</div>
	</div>

	<div id="archive-popup">
		<div id="archive-content">
			<p>Select Archive Date</p>
			<input type="date" id="archive-date-picker">
			<button id="archive-confirm">Set Archive Date</button>
			<button id="archive-close">Cancel</button>
		</div>
	</div>

	<input type="file" id="hidden-input" accept=".sb3,.pmp" style="display:none">

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<script src="https://pooiod7.neocities.org/markdown/scratchblocks.js"></script>

	<script>
		let projectData, fetchedBuffer, lastError, originalFileName;
		const picker = document.getElementById('file-picker');
		const menu = document.getElementById('menu');
		const input = document.getElementById('hidden-input');
		const extensionsContainer = document.getElementById('extensions-container');
		const header = menu.querySelector('h1');
		const saveProjectBtn = document.getElementById('save-project');
		const loadProjectBtn = document.getElementById('load-project');
		const addExtensionBtn = document.getElementById('add-extension');
		const hideExtensionBtn = document.getElementById('hide-extension');
		const addExtPopup = document.getElementById('add-extension-popup');
		const popupBack = document.getElementById('popup-back');
		const popupSet = document.getElementById('popup-set');
		const extUrlInput = document.getElementById('ext-url-input');
		const extUrlSet = document.getElementById('ext-url-set');
		const extFileInput = document.getElementById('ext-file-input');
		const extCodeInput = document.getElementById('ext-code-input');
		const extCodeSet = document.getElementById('ext-code-set');
		const tabButtons = document.querySelectorAll('.tab-button');
		const tabContents = document.querySelectorAll('.tab-content');
		const archivePopup = document.getElementById('archive-popup');
		const archiveDatePicker = document.getElementById('archive-date-picker');
		const archiveConfirm = document.getElementById('archive-confirm');
		const archiveClose = document.getElementById('archive-close');
		var dopost = false;
		let currentExtInfo = null;

		window.addEventListener("message", async (event) => {
			const data = event.data;
			console.log(data);

			if (
				data &&
				typeof data === "object" &&
				"exploreproject" in data &&
				typeof data.exploreproject === "string" &&
				data.exploreproject.startsWith("data:")
			) {
				try {
					const style = document.createElement('style');
					style.textContent = '#menu > h1 { display: none; }';
					document.head.appendChild(style);

					const response = await fetch(data.exploreproject);
					const blob = await response.blob();

					const fileName = "project";
					const file = new File([blob], fileName, { type: blob.type });

					const dataTransfer = new DataTransfer();
					dataTransfer.items.add(file);
					input.files = dataTransfer.files;

					input.dispatchEvent(new Event("change"));

					dopost = true;
				} catch (error) {
					console.error("Error processing file:", error);
				}
			}
		});

		window.parent.postMessage({ exploreprojectloaded: true }, "*");

		function updateContainerHeight() {
		const container = document.getElementById('extensions-container');
			const containerHeight = container.offsetHeight;
			container.style.setProperty('--container-height', `${containerHeight}px`);
		}
		updateContainerHeight();
		window.addEventListener('resize', updateContainerHeight);
		setInterval(updateContainerHeight, 1000);

		var BuiltIn = [
			"music",
			"pen",
			"videoSensing",
			"text2speech",
			"translate",
			"makeymakey",
			"microbit",
			"ev3",
			"boost",
			"wedo2",
			"gdxfor"
		];

		var safe = [
			"p7scratchextensions.pages.dev",
			"extensions.turbowarp.org",
			"extensions.penguinmod.com",
			"sharkpools-extensions.vercel.app"
		];

		function HideLoader() {
		    document.getElementById('loader').style.opacity = '0';
			document.getElementById('loader').style.pointerEvents = "none";
		    setTimeout(function() {
		        // document.getElementById('loader').remove();
				document.getElementById('loader').style.zIndex = 0;
				document.getElementById('loader').style.opacity = 1;
				document.getElementById('loader').style.background = "transparent";
		    }, 500);
		}

		function ShowLoader() {
		    document.getElementById('loader').style.opacity = '0';
			document.getElementById('loader').style.pointerEvents = "all";
		    setTimeout(function() {
		        // document.getElementById('loader').remove();
				document.getElementById('loader').style.zIndex = 99999;
				document.getElementById('loader').style.opacity = 1;
				document.getElementById('loader').style.background = "white";
		    }, 500);
		}

		function hidePopup() {
			const existing = document.querySelector('.popup-overlay');
			if (existing) {
				const content = existing.querySelector('.popup-content');
				content.style.transform = "translateY(-40px)";
				existing.style.opacity = "0";
				setTimeout(() => existing.remove(), 500);
			}
		}

		function showPopup(t1, t2) {
			const existing = document.querySelector('.popup-overlay');
			if (existing) {
				const content = existing.querySelector('.popup-content');
				content.style.transform = "translateY(-40px)";
				existing.style.opacity = "0";
				setTimeout(() => existing.remove(), 500);
			}

			const popup = document.createElement('div');
			popup.className = 'popup-overlay';
			popup.style.zIndex = '9999';

			const popupContent = document.createElement('div');
			popupContent.className = 'popup-content';

			popup.style.opacity = "0";
			popupContent.style.transform = "translateY(40px)";

			const title = document.createElement('h2');
			title.innerHTML = t1;

			if (t2) {
				const content = document.createElement('p');
				content.innerHTML = t2;

				const closeBtn = document.createElement('div');
				closeBtn.className = 'popup-button';
				closeBtn.textContent = 'Close';
				closeBtn.onclick = () => {
					popup.style.opacity = "0";
					popupContent.style.transform = "translateY(40px)";
					setTimeout(()=>{
						popup.remove();
					}, 500);
				};

				popupContent.appendChild(title);
				popupContent.appendChild(content);
				popupContent.appendChild(closeBtn);
			} else {
				const spinner = document.createElement('div');
				spinner.className = 'spinner';

				popupContent.style.width = "80px";
				popupContent.style.padding = "5px";
				popupContent.style.height = popupContent.style.width;
				popupContent.style.borderRadius = "50%";

				popupContent.appendChild(spinner);
			}

			popup.appendChild(popupContent);
			document.body.appendChild(popup);

			setTimeout(()=>{
				popup.style.opacity = "1";
				popupContent.style.transform = "translateY(0px)";
			}, 50);
		}

		var reposkips = 0;
		async function validateExtensounSource(ourl) {
			reposkips = 0;
			showPopup();

			function extractId(text) {
				const match = text.match(/id\s*:\s*(['"`])([^'"`]+?)\1/);
				return match ? match[2] : null;
			}

			var code = ourl;
			if (code.startsWith("https://") || code.startsWith("data:")) {
				await fetch(code).then(r => r.text()).then(text => {
					if (text.indexOf("Scratch.extensions.register") !== -1) {
						code = text;
					}
				}).catch(() => {});
			}

			var matches = [];
			var matches2 = [];

			try {
				console.log("pulling repo", "https://p7scratchextensions.pages.dev");
				var extensions = await fetch(`https://p7scratchextensions.pages.dev/extensions.json`).then(res => res.json());

				for (const ext of extensions) {
					for (const build of ["main", "dev"]) {
						const url = `https://p7scratchextensions.pages.dev/ext/${ext.id}/${build}.js`;

						try {
							console.log("pulling ext", url);
							const extCode = await fetch(url).then(res => res.text());
							const len = Math.max(extCode.length, code.length);

							let same = 0;
							for (let i = 0; i < Math.min(extCode.length, code.length); i++) {
								if (extCode[i] === code[i]) same++;
							}

							const percent = (same / len) * 100;
							var result = {
								percent,
								source: "Pooiod7's Extension Gallery",
								base: "https://p7scratchextensions.pages.dev",
								ext: ext.id,
								name: ext.title,
								url: url.replace("https://p7scratchextensions.pages.dev/ext/", "https://p7scratchextensions.pages.dev/view/#/"),
								build,
								match: `${percent.toFixed(0)}%`
							};

							if (extractId(extCode) == extractId(code)) {
								matches2.push(result);
							}
							matches.push(result);

							if (percent == 100) return result;
						} catch {}
					}
				}

				if (ourl.startsWith("https://p7scratchextensions.pages.dev/ext/")) {
					matches.sort((a, b) => b.percent - a.percent);
					if (matches[0] && matches[0].percent >= 60) {
						hidePopup();
						return matches[0];
					}
				}
			} catch {
				reposkips += 1;
				console.warn("unable to pull repo", "https://p7scratchextensions.pages.dev");
			}

			try {
				console.log("pulling repo", "https://extensions.turbowarp.org");
				var extensions = await fetch("https://extensions.turbowarp.org/").then(res => res.text())
					.then(html => {
						const parser = new DOMParser();
						const doc = parser.parseFromString(html, "text/html");
						const buttons = doc.querySelectorAll('button[data-copy]');
						const links = Array.from(buttons).map(btn => btn.getAttribute('data-copy'));
						return links;
					});

				if (!extensions || extensions == []) throw new Error("No extensions found");

				async function getExtensionNameByLink(link) {
					const res = await fetch("https://extensions.turbowarp.org/");
					const html = await res.text();
					const parser = new DOMParser();
					const doc = parser.parseFromString(html, "text/html");
					const button = doc.querySelector(`button[data-copy="${link}"]`);
					if (!button) return null;
					var par = button.parentElement.parentElement.parentElement;
					var h2s = par.getElementsByTagName("h2")
					return h2s[0].innerText.trim();
				}

				if (ourl.startsWith("https://extensions.turbowarp.org/")) {
					console.log("skipped search");
					hidePopup();
					return {
							percent: 100,
							source: "TurboWarp Extension Gallery",
							base: "https://extensions.turbowarp.org",
							ext: ourl.replace("https://extensions.turbowarp.org/", ""),
							name: await getExtensionNameByLink(ourl) || ourl.replace("https://extensions.turbowarp.org/", "").replace("lab/", "").replace(".js", ""),
							url: ourl,
							build: ourl.includes("lab/")?"experimental":"public",
							match: `100%`
					};
				}

				for (const ext of extensions) {
					try {
						console.log("pulling ext", ext);
						const extCode = await fetch(ext).then(res => res.text());
						const len = Math.max(extCode.length, code.length);

						let same = 0;
						for (let i = 0; i < Math.min(extCode.length, code.length); i++) {
							if (extCode[i] === code[i]) same++;
						}

						const percent = (same / len) * 100;
						var result = {
							percent,
							source: "TurboWarp Extension Gallery",
							base: "https://extensions.turbowarp.org",
							ext: ext.replace("https://extensions.turbowarp.org/", ""),
							name: await getExtensionNameByLink(ext) || ext.replace("https://extensions.turbowarp.org/", "").replace("lab/", "").replace(".js", ""),
							url: ext,
							build: ext.includes("lab/")?"experimental":"public",
							match: `${percent.toFixed(0)}%`
						};

						if (extractId(extCode) == extractId(code)) {
							matches2.push(result);
						}
						matches.push(result);

						if (percent == 100) return result;
					} catch {}
				}
			} catch {
				reposkips += 1;
				console.warn("unable to pull repo", "https://extensions.turbowarp.org");
			}

			try {
				console.log("pulling repo", "https://extensions.penguinmod.com");
				var extensions = await fetch("https://api.allorigins.win/raw?url=https://extensions.penguinmod.com/").then(response => response.text())
				.then(html => {
					const parser = new DOMParser();
					const doc = parser.parseFromString(html, "text/html");
					const links = Array.from(doc.querySelectorAll("a"))
						.map(a => a.href)
						.filter(href => href.includes("extensions/"))
						.map(href => href.replace("https://studio.penguinmod.com/editor.html?extension=", ""));
					return links;
				});

				if (!extensions || extensions == []) throw new Error("No extensions found");

				if (ourl.startsWith("https://extensions.penguinmod.com/extensions/")) {
					console.log("skipped search");
					hidePopup();
					return {
						percent: 100,
						source: "PenguinMod Extra Extensions",
						base: "https://extensions.penguinmod.com",
						ext: ourl.replace("https://extensions.penguinmod.com/extensions/", ""),
						name: ourl.replace("https://extensions.penguinmod.com/extensions/", "").replace("/", "'s ").replace(".js", "").replace("pooiod's", "pooiod7's"),
						url: ourl,
						build: "public",
						match: `100%`
					};
				}

				for (const ext of extensions) {
					try {
						console.log("pulling ext", ext);
						const extCode = await fetch(ext).then(res => res.text());
						const len = Math.max(extCode.length, code.length);

						let same = 0;
						for (let i = 0; i < Math.min(extCode.length, code.length); i++) {
							if (extCode[i] === code[i]) same++;
						}

						const percent = (same / len) * 100;
						var result = {
							percent,
							source: "PenguinMod Extra Extensions",
							base: "https://extensions.penguinmod.com",
							ext: ext.replace("https://extensions.penguinmod.com/extensions/", ""),
							name: ext.replace("https://extensions.penguinmod.com/extensions/", "").replace("/", "'s ").replace(".js", ""),
							url: ext,
							build: "public",
							match: `${percent.toFixed(0)}%`
						};

						if (extractId(extCode) == extractId(code)) {
							matches2.push(result);
						}
						matches.push(result);

						if (percent == 100) return result;
					} catch {}
				}
			} catch {
				reposkips += 1;
				console.warn("unable to pull repo", "https://extensions.penguinmod.com");
			}

			try {
				console.log("pulling repo", "https://github.com/Snail-IDE/snail-ide.github.io");

				async function fetchJSFiles() {
					const apiUrl = 'https://api.github.com/repos/Snail-IDE/snail-ide.github.io/contents/static?ref=develop';
					const response = await fetch(apiUrl);
					if (!response.ok) {
						throw new Error(`GitHub API responded with status ${response.status}`);
					}
					const data = await response.json();
					const jsFiles = data
						.filter(item => item.type === 'file' && item.name.endsWith('.js'))
						.map(item => item.name);
					return jsFiles;
				}
				var extensions = await fetchJSFiles();

				if (!extensions || extensions == []) throw new Error("No extensions found");

				for (const ext of extensions) {
					try {
						console.log("pulling ext", ext);
						const extCode = await fetch("https://raw.githubusercontent.com/Snail-IDE/snail-ide.github.io/refs/heads/develop/static/" + ext).then(res => res.text());
						const len = Math.max(extCode.length, code.length);

						let same = 0;
						for (let i = 0; i < Math.min(extCode.length, code.length); i++) {
							if (extCode[i] === code[i]) same++;
						}

						const percent = (same / len) * 100;
						var result = {
							percent,
							source: "Snail ide",
							base: "https://snail-ide.js.org/editor.html",
							ext: ext,
							name: ext.replace(".js", ""),
							url: "https://github.com/Snail-IDE/snail-ide.github.io/blob/develop/static/" + ext,
							build: "public",
							match: `${percent.toFixed(0)}%`
						};

						if (extractId(extCode) == extractId(code)) {
							matches2.push(result);
						}
						matches.push(result);

						if (percent == 100) return result;
					} catch {}
				}
			} catch {
				reposkips += 1;
				console.warn("unable to pull repo", "https://snail-ide.js.org/editor.html");
			}

			try {
				console.log("pulling repo", "https://sharkpools-extensions.vercel.app");

				async function fetchJSFiles() {
					const apiUrl = 'https://api.github.com/repos/SharkPool-SP/SharkPools-Extensions/contents/extension-code?ref=main';
					const response = await fetch(apiUrl);
					if (!response.ok) {
						throw new Error(`GitHub API responded with status ${response.status}`);
					}
					const data = await response.json();
					const jsFiles = data
						.filter(item => item.type === 'file' && item.name.endsWith('.js'))
						.map(item => item.name);
					return jsFiles;
				}
				var extensions = await fetchJSFiles();

				if (!extensions || extensions == []) throw new Error("No extensions found");

				for (const ext of extensions) {
					try {
						console.log("pulling ext", ext);
						const extCode = await fetch("https://raw.githubusercontent.com/SharkPool-SP/SharkPools-Extensions/refs/heads/main/extension-code/" + ext).then(res => res.text());
						const len = Math.max(extCode.length, code.length);

						let same = 0;
						for (let i = 0; i < Math.min(extCode.length, code.length); i++) {
							if (extCode[i] === code[i]) same++;
						}

						const percent = (same / len) * 100;
						var result = {
							percent,
							source: "SharkPool's Extension Collection",
							base: "https://sharkpools-extensions.vercel.app",
							ext: ext,
							name: ext.replace(".js", ""),
							url: "https://github.com/SharkPool-SP/SharkPools-Extensions/blob/main/extension-code/" + ext,
							build: "public",
							match: `${percent.toFixed(0)}%`
						};

						if (extractId(extCode) == extractId(code)) {
							matches2.push(result);
						}
						matches.push(result);

						if (percent == 100) return result;
					} catch {}
				}
			} catch {
				reposkips += 1;
				console.warn("unable to pull repo", "https://sharkpools-extensions.vercel.app");
			}

			matches.sort((a, b) => b.percent - a.percent);
			matches2.sort((a, b) => b.percent - a.percent);

			console.log(matches);

			if (matches[0] && matches[0].percent >= 60) {
				hidePopup();
				return matches[0];
			}

			if (matches2[0]) {
				hidePopup();
				matches2[0].percent = 1;
				return matches2[0];
			}

			hidePopup();
			return false;
		}

		async function ExtensionToScratchblocks(url) {
			var Scratch = {
				extensions: {
					unsandboxed: true
				},

				exports: {
					Skin: new class {
						constructor() {}
					},
					JSZip: JSZip
				},

				fetch: fetch,
				canFetch: true,

				ArgumentType: {
					STRING: "string",
					BOOLEAN: "boolean"
				},
				BlockType: {
					COMMAND: "command",
					REPORTER: "reporter",
					BOOLEAN: "boolean",
					CONDITIONAL: "conditional",
					LOOP: "loop",
					EVENT: "event",
					HAT: "hat"
				},
				TargetType: {
					STAGE: "stage",
					SPRITE: "sprite"
				},

				Cast: {
					toBoolean: function(arg1) {
						return !!arg1;
					},
				},

				translate: function(arg1) {
					if (arg1.default) return arg1.default;
					return arg1;
				}
			};

			Scratch.translate.setup = function(){};

			Scratch.vm = {
				exports: Scratch.exports,

				runtime: {
					vm: Scratch.vm,
					exports: Scratch.exports,
					stageWidth: 480,
					stageHeight: 360,

					frameLoop: {
						framerate: {}
					},

					ioDevices: {
						mouse: {
							getScratchX: function() {
								return 0;
							},
							getScratchY: function() {
								return 0;
							}
						}
					},

					targets: {
						t1: {}
					},

					_step: function(){},
					on: function(){}
				},

				renderer: {
					exports: Scratch.exports,
					vm: Scratch.vm,
					canvas: null
				},
			}

			Scratch.vm.runtime.renderer = Scratch.vm.renderer
			Scratch.vm.renderer.runtime = Scratch.vm.runtime;

			async function ext2sblock(url) {
				const script = document.createElement('script');
				script.src = url;

				script.onerror = (err) => {
					document.head.removeChild(script);
					console.warn(err);
				}

				var timeout298498 = setTimeout(function() {
					resolve492804("failedtoload");
				}, 5000);

				Scratch.extensions.register = (ext) => {
					var scratchblocks = [];
					var blocks = ext.getInfo().blocks;

					for (const block of blocks) {
						const { opcode, blockType, text, arguments: args = {} } = block;
						let formattedText = text;

						for (const [argName, argInfo] of Object.entries(args)) {
							var defaultVal = argInfo.defaultValue || '';

							if (argInfo.menu && !defaultVal) {
								defaultVal = ext.getInfo().menus[argInfo.menu];
								if (defaultVal.items) {
									defaultVal = defaultVal.items[0];

									if (defaultVal.text) {
										defaultVal = defaultVal.text;
									}
								} else {
									defaultVal = defaultVal[0];
								}
							}
							if (argInfo.menu) defaultVal = defaultVal + " v";

							var argStr = defaultVal + ""
								.replace(new RegExp(`\n`, 'g'), ` `)
								.replace(new RegExp(`]`, 'g'), `\\]`)
								.replace(new RegExp(`>`, 'g'), `\\>`)
								.replace(new RegExp(`}`, 'g'), `\\}`);
							argStr = `[${argStr}]`;

							formattedText = formattedText.replace(new RegExp(`\\[${argName}\\]`, 'g'), argStr);
						}

						const colorTag = `:: ${ext.getInfo().color1 || "#0fbd8c"}`;
						var blockFormatted = `//${formattedText}`;
						if (blockType === Scratch.BlockType.COMMAND) {
							blockFormatted = formattedText.replace("ef", "еf").replace("en", "еn") + colorTag;
						} else if (blockType === Scratch.BlockType.REPORTER) {
							blockFormatted = `(${formattedText} ${colorTag})`;
						} else if (blockType === Scratch.BlockType.BOOLEAN) {
							blockFormatted = `<${formattedText} ${colorTag}>`;
						} else if (blockType === Scratch.BlockType.EVENT || blockType === Scratch.BlockType.HAT) {
							blockFormatted = `${formattedText} ${colorTag} hat`;
						} else if (blockType === Scratch.BlockType.CONDITIONAL || blockType === Scratch.BlockType.LOOP) {
							blockFormatted = `${formattedText} {\n} ${colorTag}`;
						} else if (!blockType && !formattedText) {
							blockFormatted = `//---`;
						}

						if (block.hideFromPalette) {
							if (blockFormatted.startsWith("//")) {
								blockFormatted = blockFormatted + " - hidden lable";
							} else {
								blockFormatted = blockFormatted + "//hidden block";
							}
						}

						scratchblocks.push(blockFormatted);
					}

					document.head.removeChild(script);

					clearTimeout(timeout298498);
					window.resolve492804(scratchblocks.join('\n\n'));
				};

				document.head.appendChild(script);

				return new Promise(resolve => {
					window.resolve492804 = (input)=> {
						window.resolve492804 = null;
						resolve(input);
					};
				});
			}

			if (navigator.userAgent.toLowerCase().includes('firefox')) {
				Scratch.vm.runtime.renderer.canvas = document.getElementById("6734827468294793829");
				window.Scratch = Scratch;

				return await ext2sblock(url);
			} else {
				var iframe = document.createElement('iframe');
				iframe.style.display = 'none';
				document.body.appendChild(iframe);
				var sandboxWindow = iframe.contentWindow;
				var sandboxDoc = iframe.contentDocument || iframe.contentWindow.document;

				sandboxDoc.open();
				sandboxDoc.write(`<head></head><body><div><div><div><div><div><canvas id="6734827468294793829"></canvas></div></div></div></div></div></body>`);
				sandboxDoc.close();

				Scratch.vm.runtime.renderer.canvas = sandboxWindow.document.getElementById("6734827468294793829");
				sandboxWindow.Scratch = Scratch;

				return await sandboxWindow.eval(`(${ext2sblock.toString()})("${url}")`).finally(() => {
					document.body.removeChild(iframe);
				});
			}
		}

		function formatToday() {
		    let today = new Date();
		    let dd = String(today.getDate()).padStart(2, '0');
		    let mm = String(today.getMonth() + 1).padStart(2, '0');
		    let yyyy = today.getFullYear();
		    return `${yyyy}-${mm}-${dd}`;
		}

		function validateExtension(elm, url) {
		    elm.style.background = "#fff";
		    fetch(url)
		        .then(r => r.text())
		        .then(text => {
		            if (text.indexOf("Scratch.extensions.register") !== -1) {
		                elm.style.background = "#f0fffc";
		            } else {
		                elm.style.background = "#fffbeb";
		            }
		        })
		        .catch(() => {
		            elm.style.background = "#fffbeb";
		        });
		}

		function updateExtensionSettings(extButton, inputUrl, findArchive, removeArchive, validateSource, renderExtension, extId,) {
		    let url = inputUrl.value.trim();
		    if (url === "" || url.startsWith("data:")) {
		        findArchive.disabled = true;
		        findArchive.textContent = "Find archive";
		        removeArchive.style.display = "none";
		    } else if (url.includes("web.archive.org")) {
		        findArchive.disabled = false;
		        findArchive.textContent = "Change archive date";
		        removeArchive.style.display = "block";
		    } else {
		        findArchive.disabled = false;
		        findArchive.textContent = "Find archive";
		        removeArchive.style.display = "none";
		    }

			if (!projectData.extensionURLs[extId]) {
				validateSource.disabled = true;
				renderExtension.disabled = true;
			} else {
				validateSource.disabled = false;
				renderExtension.disabled = false;
			}
		}
		picker.addEventListener('click', () => input.click());
		picker.addEventListener('dragover', e => {
		    e.preventDefault();
		    picker.classList.add('dragover');
		});
		picker.addEventListener('dragleave', () => picker.classList.remove('dragover'));
		picker.addEventListener('drop', e => {
		    e.preventDefault();
		    picker.classList.remove('dragover');
		    handleFile(e.dataTransfer.files[0]);
		});
		input.addEventListener('change', () => {
		    if (input.files.length > 0) handleFile(input.files[0]);
		});
		saveProjectBtn.addEventListener('click', () => {
		JSZip.loadAsync(fetchedBuffer)
			.then(zip => {
				zip.file("project.json", JSON.stringify(projectData, null, 2));
				return zip.generateAsync({ type: "blob" });
			})
			.then(blob => {
				if (!fetchedBuffer || !originalFileName) return;
				if (dopost) {
					const reader = new FileReader();

					reader.onload = function () {
						const dataUri = reader.result;
						window.parent.postMessage({ exploreproject: dataUri }, "*");
					};

					reader.onerror = function (err) {
						console.error("Failed to convert blob to data URI:", err);
					};

					reader.readAsDataURL(blob);
				} else {
					const a = document.createElement('a');
					const url = URL.createObjectURL(blob);
					a.href = url;
					a.download = originalFileName;
					document.body.appendChild(a);
					a.click();
					a.remove();
					URL.revokeObjectURL(url);
				}
			})
			.catch(err => { alert(`Error saving project: ${err}`); });
		});
		loadProjectBtn.addEventListener('click', () => {
		    input.click();
		});
		addExtensionBtn.addEventListener('click', () => {
		    addExtPopup.style.display = "flex";
		});
		hideExtensionBtn.addEventListener('click', () => {
			hideExtensionBtn.style.opacity = "0";
			hideExtensionBtn.style.padding = "0";
			setTimeout(()=>{
				document.getElementById("scratchblockscontainer").classList.remove("visible");
				menu.classList.add('visible');
				setTimeout(()=>{
					menu.classList.add('outline');
					document.getElementById("scratchblockscontainer").classList.remove("outline");
					hideExtensionBtn.style.display = "none";
					// menu.style.borderLeft = '1px solid #ccc';
				}, 500);
			}, 300);
		});
		popupBack.addEventListener('click', () => {
		    addExtPopup.style.display = "none";
		});
		tabButtons.forEach(btn => {
		    btn.addEventListener('click', () => {
		        tabButtons.forEach(b => b.classList.remove('active'));
		        tabContents.forEach(c => c.classList.remove('active'));
		        btn.classList.add('active');
		        document.getElementById(btn.getAttribute('data-tab')).classList.add('active');
		    });
		});
		extUrlSet.addEventListener('click', () => {
		    let url = extUrlInput.value.trim();
		    if (url === "") {
		        alert("Enter a URL");
		        return;
		    }
		    fetch(url)
		        .then(r => r.text())
		        .then(code => {
		            processExtension(code, url);
		        })
		        .catch(() => {
		            alert("Failed to fetch URL");
		        });
		});
		extFileInput.addEventListener('change', () => {
		    if (extFileInput.files.length > 0) {
		        const file = extFileInput.files[0];
		        const fr = new FileReader();
		        fr.onload = () => {
		            const code = fr.result;
		            let dataUri = "data:text/javascript;base64," + btoa(code);
		            processExtension(code, dataUri);
		        };
		        fr.readAsText(file);
		    }
		});
		extCodeSet.addEventListener('click', () => {
		    let code = extCodeInput.value;
		    if (code.trim() === "") {
		        alert("Enter code");
		        return;
		    }
		    processExtension(code, null);
		});
		popupSet.addEventListener('click', () => {
		    let activeTab = document.querySelector('.tab-content.active').id;
		    if (activeTab === "url-tab") {
		        let url = extUrlInput.value.trim();
		        if (url === "") {
		            alert("Enter a URL");
		            return;
		        }
		        fetch(url)
		            .then(r => r.text())
		            .then(code => {
		                processExtension(code, url);
		            })
		            .catch(() => {
		                alert("Failed to fetch URL");
		            });
		    } else if (activeTab === "file-tab") {
		        if (extFileInput.files.length > 0) {
		            const file = extFileInput.files[0];
		            const fr = new FileReader();
		            fr.onload = () => {
		                const code = fr.result;
		                let dataUri = "data:text/javascript;base64," + btoa(code);
		                processExtension(code, dataUri);
		            };
		            fr.readAsText(file);
		        } else {
		            alert("Select a file");
		        }
		    } else if (activeTab === "code-tab") {
		        let code = extCodeInput.value;
		        if (code.trim() === "") {
		            alert("Enter code");
		            return;
		        }
		        processExtension(code, null);
		    }
		});
		archiveClose.addEventListener('click', () => {
		    archivePopup.style.display = "none";
		});
		archiveConfirm.addEventListener('click', () => {
		    let dateVal = archiveDatePicker.value;
		    if (!dateVal) {
		        alert("Select a date");
		        return;
		    }
		    let formattedDate = dateVal.replace(/-/g, "");
		    let currentUrl = currentExtInfo.inputUrl.value;
		    let newUrl = "";
		    if (currentUrl.startsWith("https://api.allorigins.win/raw?url=")) {
		        let decoded = decodeURIComponent(currentUrl.replace("https://api.allorigins.win/raw?url=", ""));
		        if (decoded.includes("web.archive.org/web/")) {
		            newUrl = decoded.replace(/(web\/)\d{8}(id_\/)/, "$1" + formattedDate + "id_/");
		        } else {
		            newUrl = "https://web.archive.org/web/" + formattedDate + "id_/" + currentExtInfo.originalUrl;
		        }
		    } else {
		        newUrl = "https://web.archive.org/web/" + formattedDate + "id_/" + currentExtInfo.originalUrl;
		    }
		    let wrappedUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(newUrl);
		    projectData.extensionURLs[currentExtInfo.extId] = wrappedUrl;
		    currentExtInfo.inputUrl.value = wrappedUrl;
		    validateExtension(currentExtInfo.extButton, wrappedUrl);
		    archivePopup.style.display = "none";
		});

		function processExtension(code, source) {
		    let m = code.match(/id\s*:\s*(?:"([^"]+)"|'([^']+)'|([^,"}]+))/);
		    if (m) {
		        let extId = (m[1] || m[2] || m[3]).trim();
		        if (!projectData.extensions) {
		            projectData.extensions = [];
		        }
		        if (!projectData.extensionURLs) {
		            projectData.extensionURLs = {};
		        }
		        if (projectData.extensions.indexOf(extId) === -1) {
		            projectData.extensions.push(extId);
		            if (source) {
		                projectData.extensionURLs[extId] = source;
		            }
		        }
		        buildExtensions();
		        addExtPopup.style.display = "none";
		        extUrlInput.value = "";
		        extCodeInput.value = "";
		        extFileInput.value = "";
		    } else {
		        alert("Error: id not found");
		    }
		}

		function generateDummy(extId) {
			try {
				let blocksMap = {};
				let allBlocks = {};
				projectData.targets.forEach(target => {
					if (target.blocks) {
						Object.entries(target.blocks).forEach(([BlockKey, block]) => {
							if (typeof block.opcode === "string" && block.opcode.startsWith(extId + "_")) {
								let blockId = block.opcode.slice(extId.length + 1);

								if (!blocksMap[blockId]) {
									blocksMap[blockId] = { inputs: {}, reporter: false };
								}

								// Most C blocks in Scratch seem to use "SUBSTACK" at the start for each input
								if (block.parent !== null && block.parent !== undefined && target.blocks[block.parent]) {
									var thingy = BlockKey.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
									thingy = JSON.stringify(target.blocks[block.parent].inputs).replace(new RegExp(`"${thingy}":`, 'g'), '');

									if (!JSON.stringify(target.blocks[block.parent].inputs).includes(`"SUBSTACK`) && thingy.includes(`"${BlockKey}"`)){
										blocksMap[blockId].reporter = true;
									}

									if (JSON.stringify(blocksMap[blockId]).includes(`"SUBSTACK`)) {
										blocksMap[blockId].reporter = false;
										blocksMap[blockId].Cblock = true;
									}
								}

								if (block.inputs) {
									Object.keys(block.inputs).forEach(inputKey => {
										blocksMap[blockId].inputs[inputKey] = true;
									});
								}
							}
						});
					}
				});
				let blocksArr = [];
				Object.keys(blocksMap).forEach(blockId => {
					let argKeys = Object.keys(blocksMap[blockId].inputs);
					let text = `${blockId}${argKeys.map(a => ` [${a}]`).join('')}`;
					let args = {};
					argKeys.forEach(a => {
						args[a] = { type: "string", defaultValue: a };
					});
					let blockType = "";
					if (blocksMap[blockId].reporter && !blocksMap[blockId].Cblock) {
						blockType = "reporter";
					} else if (blocksMap[blockId].Cblock) {
						blockType = "conditional";
					} else {
						blockType = "command";
					}
					blocksArr.push({
						opcode: blockId,
						blockType: blockType,
						text: text,
						arguments: args
					});
				});
				let generated = `// Generated extension template
(function(Scratch) {
	'use strict';
	class ${extId} {
		getInfo() {
			return {
				id: '${extId}',
				name: '${extId} Generated',
				color1: '#ed4242',
				blocks: ${JSON.stringify(blocksArr, null, 16)}
			};
		}
		${blocksArr.map(b => `${b.opcode}(args) {}`).join('\n        ')}
	}
	Scratch.extensions.register(new ${extId}());
})(Scratch);`;
				return generated;
			} catch (err) {
				alert(err);
			}
		}

		function generateDummyForExtension(extButton, inputUrl, extId, genDummy) {
		    if (extId === "") return;
		    let code = generateDummy(extId);
		    let dataUri = "data:text/javascript;base64," + btoa(code);
		    projectData.extensionURLs[extId] = dataUri;
		    inputUrl.value = dataUri;
		    validateExtension(extButton, dataUri);
		}

		function removeArchiveForExtension(extButton, inputUrl) {
		    let url = inputUrl.value.trim();
		    if (url.startsWith("https://api.allorigins.win/raw?url=")) {
		        let decoded = decodeURIComponent(url.replace("https://api.allorigins.win/raw?url=", ""));
		        let m = decoded.match(/web\/\d{8}id_\/(.*)/);
		        if (m) {
		            let orig = m[1];
		            let extId = "";
		            projectData.extensions.forEach(id => {
		                if (inputUrl.value.includes(id)) {
		                    extId = id;
		                }
		            });
		            projectData.extensionURLs[extId] = orig;
		            inputUrl.value = orig;
		            validateExtension(extButton, orig);
		        }
		    }
		}

		function handleFile(file) {
		    if (!file) return;
		    originalFileName = file.name;
		    if (menu.classList.contains('visible')) {
		        menu.classList.remove('visible');
		        setTimeout(() => process(file), 500);
		    } else {
		        process(file);
		    }
		}

		function process(file) {
		    const reader = new FileReader();
			picker.style.opacity = 0;

			picker.classList.add("picked");

			hideExtensionBtn.style.opacity = "0";
			hideExtensionBtn.style.padding = "0";
			document.getElementById("scratchblockscontainer").classList.remove("visible");
			setTimeout(()=>{
				menu.classList.add('outline');
				document.getElementById("scratchblockscontainer").classList.remove("outline");
				hideExtensionBtn.style.display = "none";
				// menu.style.borderLeft = '1px solid #ccc';
			}, 500);

		    reader.onload = () => {
		        fetchedBuffer = reader.result;

		        JSZip.loadAsync(fetchedBuffer)
		            .then(zip => {
		                return zip.file('project.json').async('string');
		            })
		            .then(json => {
		                projectData = JSON.parse(json);

						if (projectData && projectData.info && projectData.info.flashVersion) throw new Error("Scratch2 projects are unsuported");
						if (!projectData || !projectData.meta) throw new Error("Unknown project format");

						if (!projectData.extensionURLs) projectData.extensionURLs = {};

		                return getThumbnail({
		                    WIDTH: 480,
		                    HEIGHT: 360
		                });
		            })
		            .then(bg => {
		                if (bg.startsWith('data:image')) {
		                    setTimeout(() => {
								picker.style.backgroundColor = "white";
		                        picker.style.backgroundImage = `url(${bg})`;
		                        picker.innerHTML = '';
		                        picker.style.opacity = 1;
		                        header.textContent = file.name;
		                        menu.classList.add('visible');
		                        buildExtensions();
		                    }, 600);
		                }
		            }).catch((err) => {
						picker.style.backgroundColor = "#eaeaea";
						picker.style.backgroundImage = `none`;
						picker.innerHTML = `<span>Load a Scratch project</span>`;
						picker.style.opacity = 1;
						alert(err);
					});
		    };
		    reader.readAsArrayBuffer(file);
		}

		function buildExtensions() {
		    extensionsContainer.innerHTML = '';
		    if (projectData.extensions && projectData.extensions.length > 0) {
		        projectData.extensions.forEach(extId => {
		            const extItem = document.createElement('div');
		            extItem.className = 'ext-item';
		            const extButton = document.createElement('button');
		            extButton.className = 'ext-button';
		            extButton.style.background = "#f0f0f0";
					if (BuiltIn.includes(extId)) {
						extButton.style.background = "#edffed";
					}
		            const spanText = document.createElement('span');
		            spanText.textContent = extId;
		            const arrow = document.createElement('span');
		            arrow.className = 'ext-arrow';
		            arrow.textContent = '▶';
		            extButton.appendChild(spanText);
		            extButton.appendChild(arrow);
		            const dropdown = document.createElement('div');
		            dropdown.className = 'ext-dropdown';
		            const inputUrl = document.createElement('input');
		            inputUrl.type = 'text';
		            inputUrl.value = (projectData.extensionURLs && projectData.extensionURLs[extId]) || "";
		            inputUrl.placeholder = "Add a url";
		            inputUrl.addEventListener('change', () => {
		                const newUrl = inputUrl.value.trim();
		                if (newUrl === "") {
		                    delete projectData.extensionURLs[extId];
		                    extButton.style.background = "#f0f0f0";
							if (BuiltIn.includes(extId)) {
								extButton.style.background = "#edffed";
							}
		                } else {
		                    projectData.extensionURLs[extId] = newUrl;
		                    validateExtension(extButton, newUrl);
		                }
		                updateExtensionSettings(extButton, inputUrl, findArchive, removeArchive, validateSource, renderExtension, extId);
		            });
		            const genDummy = document.createElement('button');
		            genDummy.textContent = "Generate replacement";
		            genDummy.disabled = false;
		            genDummy.addEventListener('click', () => {
		                generateDummyForExtension(extButton, inputUrl, extId, genDummy);
		            });
		            const findArchive = document.createElement('button');
		            let hasUrl = (projectData.extensionURLs[extId] && !projectData.extensionURLs[extId].startsWith("data:"));
		            if (!hasUrl) {
		                findArchive.disabled = true;
		            }
		            if (hasUrl && projectData.extensionURLs[extId].includes("web.archive.org")) {
		                findArchive.textContent = "Change archive date";
		            } else {
		                findArchive.textContent = "Set archive date";
		            }
		            findArchive.addEventListener('click', () => {
		                currentExtInfo = {
		                    extId,
		                    extButton,
		                    inputUrl
		                };
		                let currentUrl = projectData.extensionURLs[extId] || "";
		                if (currentUrl.startsWith("https://api.allorigins.win/raw?url=")) {
		                    let decoded = decodeURIComponent(currentUrl.replace("https://api.allorigins.win/raw?url=", ""));
		                    let m = decoded.match(/web\/(\d{8})id_\//);
		                    if (m) {
		                        currentExtInfo.originalUrl = decoded.split("id_/")[1] || "";
		                        archiveDatePicker.value = m[1].slice(0, 4) + "-" + m[1].slice(4, 6) + "-" + m[1].slice(6, 8);
		                    } else {
		                        currentExtInfo.originalUrl = currentUrl;
		                        archiveDatePicker.value = formatToday();
		                    }
		                } else {
		                    currentExtInfo.originalUrl = currentUrl;
		                    archiveDatePicker.value = formatToday();
		                }
		                archivePopup.style.display = "flex";
		            });
		            const removeArchive = document.createElement('button');
		            removeArchive.textContent = "Remove archive";
		            removeArchive.style.display = "none";
		            removeArchive.addEventListener('click', () => {
		                removeArchiveForExtension(extButton, inputUrl);
		            });
		            const validateSource = document.createElement('button');
		            validateSource.textContent = "Validate source";
		            validateSource.disabled = false;
		            if (!projectData.extensionURLs[extId]) {
		                validateSource.disabled = true;
		            }
		            validateSource.addEventListener('click', async () => {
						var result = await validateExtensounSource(projectData.extensionURLs[extId]);
		                if (result) {
							if (result.percent <= 30) {
								showPopup("Possible match found", `This extension might be a modified version of "<a target="_blank" href="${result.url}">${result.name}<a>" ${result.build=="public"?"":`(${result.build} build)`}<br>Found on <a target="_blank" href="${result.base}">${result.source}</a>`);
							} else if (result.percent <= 80) {
								showPopup("Close match found", `This extension could be an old version of "<a target="_blank" href="${result.url}">${result.name}<a>" ${result.build=="public"?"":`(${result.build} build)`} from <a target="_blank" href="${result.base}">${result.source}</a><br>(${result.match} match)`);
							} else {
								showPopup("Extension source found", `This extension is "<a target="_blank" href="${result.url}">${result.name}<a>" ${result.build=="public"?"":`(${result.build} build)`}<br>You may find it on <a target="_blank" href="${result.base}">${result.source}</a>`);
							}
		                } else {
							if (reposkips) {
								showPopup("No extension was found", `This extension was not found in any reputable repositories<br>(${reposkips} repos could not be searched)`);
							} else {
								showPopup("No extension was found", `This extension was not found in any reputable repositories`);
							}
		                }
		            });
		            const renderExtension = document.createElement('button');
		            renderExtension.textContent = "Render extension";
		            renderExtension.disabled = false;
		            if (!projectData.extensionURLs[extId]) {
		                renderExtension.disabled = true;
		            }
		            renderExtension.addEventListener('click', async () => {
						renderExtension.disabled = true; // showPopup();
						hideExtensionBtn.style.padding = "0";
						document.getElementById("scratchblockscontainer").classList.remove("visible");
						document.getElementById("scratchblockscontainer").classList.remove("outline");
						menu.classList.add('outline');
						hideExtensionBtn.style.opacity = "0";
						hideExtensionBtn.style.display = "none";
						document.getElementById("scratchblocks").innerText = await ExtensionToScratchblocks(projectData.extensionURLs[extId]);
						renderExtension.disabled = !projectData.extensionURLs[extId]; // hidePopup();

						if (document.getElementById("scratchblocks").innerText == "failedtoload") {
							showPopup("Extension error", "Failed to load extension");
						} else if (!document.getElementById("scratchblocks").innerText) {
							showPopup("No blocks", "This extension has no blocks");
						} else {
							hideExtensionBtn.style.display = "block";
							menu.classList.remove('visible');

							document.getElementById("scratchblockscontainer").scrollTop = 0;
							document.getElementById("scratchblockscontainer").classList.add("visible");
							document.getElementById("scratchblockscontainer").classList.add("outline");
							menu.classList.remove('outline');

							setTimeout(()=>{
								hideExtensionBtn.style.padding = "10px";
								hideExtensionBtn.style.opacity = "1";
							}, 500);

							scratchblocks.init();
							scratchblocks.module.renderMatching("#scratchblocks", {
								style: "scratch3",
							});
						}
		            });
		            dropdown.appendChild(inputUrl);
					dropdown.appendChild(validateSource);
		            dropdown.appendChild(genDummy);
		            dropdown.appendChild(findArchive);
		            dropdown.appendChild(removeArchive);
					dropdown.appendChild(renderExtension);
		            extButton.addEventListener('click', () => {
		                dropdown.classList.toggle('open');
		                arrow.classList.toggle('open');
		                updateExtensionSettings(extButton, inputUrl, findArchive, removeArchive, validateSource, renderExtension, extId);
		            });
		            extItem.appendChild(extButton);
		            extItem.appendChild(dropdown);
		            extensionsContainer.appendChild(extItem);
		            if (projectData.extensionURLs && projectData.extensionURLs[extId]) {
		                validateExtension(extButton, projectData.extensionURLs[extId]);
		            }
		            updateExtensionSettings(extButton, inputUrl, findArchive, removeArchive, validateSource, renderExtension, extId);
		        });
		    }
		}

		function getThumbnail({
		    WIDTH,
		    HEIGHT
		}) {
		    if (!projectData) {
		        lastError = "No project loaded.";
		        console.error(lastError);
		        return Promise.resolve(lastError);
		    }
		    const canvas = document.createElement("canvas");
		    const ctx = canvas.getContext("2d");
		    canvas.width = WIDTH;
		    canvas.height = HEIGHT;
		    return JSZip.loadAsync(fetchedBuffer)
		        .then(zip => {
		            const targets = projectData.targets.filter(t => t.visible !== false)
		                .sort((a, b) => (a.layerOrder || 0) - (b.layerOrder || 0));
		            const drawPromises = targets.map(target => {
		                const costume = target.costumes[target.currentCostume];
		                if (!costume) return Promise.resolve();
		                return zip.file(costume.md5ext).async("base64").then(imageData => {
		                    return new Promise((resolve, reject) => {
		                        const img = new Image();
		                        img.src = costume.dataFormat === "svg" ? `data:image/svg+xml;base64,${imageData}` : `data:image/png;base64,${imageData}`;
		                        const timer = setTimeout(() => reject("Image load timeout"), 5000);
		                        img.onload = () => {
		                            clearTimeout(timer);
		                            ctx.save();
		                            ctx.translate(WIDTH / 2 + (target.x || 0), HEIGHT / 2 - (target.y || 0));
		                            ctx.rotate(((target.direction || 90) - 90) * (Math.PI / 180));
		                            ctx.scale((target.size || 100) / 100, (target.size || 100) / 100);
		                            const rotationCenterX = costume.rotationCenterX || 0;
		                            const rotationCenterY = costume.rotationCenterY || 0;
		                            ctx.drawImage(img, -rotationCenterX, -rotationCenterY);
		                            ctx.restore();
		                            resolve();
		                        };
		                        img.onerror = () => {
		                            clearTimeout(timer);
		                            reject("Image failed to load");
		                        };
		                    });
		                });
		            });
		            return Promise.all(drawPromises);
		        }).then(() => canvas.toDataURL("image/png"))
		        .catch(error => {
		            console.error(error);
		            lastError = error.toString();
		            return lastError;
		        });
		}

		setTimeout(HideLoader, 500);
	</script>

<div><div><div><div><div><canvas id="6734827468294793829"></canvas></div></div></div></div></div>
</body>
</html>
