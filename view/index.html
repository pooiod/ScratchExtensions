<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Scratch Extension Viewer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <style>
        :root {
            --bg: #f7f9fb;
            --panel: #fff;
            --muted: #6b7280;
            --accent: #0f62fe;
            --border: #e6eaee;
            --mint: #b8f7cc;
            --mint-outline: #34d399;
        }
        html, body {
            height: 100%;
            margin: 0;
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
            background: var(--bg);
            color: #111;
            overflow-x: hidden;
        }
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: #fff;
            overflow-x: auto;
            min-width: 460px;
            box-sizing: border-box;
        }
        .left-head {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        .back {
            appearance: none;
            background: none;
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 6px;
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
            cursor: pointer;
        }
        .ext-title {
            font-weight: 800;
            font-size: 18px;
            position: relative;
            white-space: nowrap;
        }
        .ext-id {
            opacity: 0;
            position: absolute;
            bottom: -16px;
            left: 0;
            font-size: 12px;
            color: var(--muted);
            transition: opacity .2s;
        }
        .ext-title:hover .ext-id {
            opacity: 1;
        }
        .wip-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: 6px;
            vertical-align: middle;
            flex-shrink: 0;
        }
        .meta-btns {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }
        select.builds {
            padding: 9px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--panel);
        }
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0px;
            padding: 0px;
            overflow: auto;
        }
        .panel {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            border-radius: 0px;
            padding: 14px;
        }
        .nopadding {
            padding: 0px;
        }
        .panel h2 {
            margin-top: 0px;
            margin-bottom: 10px;
        }
        .code-wrap {
            max-height: calc(100vh - 113px);
            overflow: auto;
            /* border: 1px solid var(--border); */
        }
        pre {
            margin: 0;
            padding: 0px;
            white-space: pre;
            overflow: auto;
            font-size: 13px;
            line-height: 1.45;
        }
        .preview {
            height: calc(100vh - 90px);
            border: 1px solid var(--border);
            transition: max-height .5s ease-in-out, opacity 0.5s ease-in-out;
            overflow: hidden;
        }
        .preview iframe {
            width: 100%;
            height: 100%;
            transition: max-height 0.3s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 0%;
            border: 0;
        }
        .sidebar {
            width: 360px;
            padding: 16px;
            border-left: 1px solid var(--border);
            box-sizing: border-box;
            overflow: auto;
            background: var(--bg);
            transition: transform .28s ease, opacity .28s ease;
            flex-shrink: 0;
        }
        .sidebar.hidden {
            transform: translateY(100%);
            opacity: 0;
            pointer-events: none;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            border-left: 0;
            border-top: 1px solid var(--border);
            max-height: 0;
        }
        .sidebar.visible {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            border-left: 0;
            border-top: 1px solid var(--border);
            max-height: 80vh;
        }
        .toggle-comments {
            display: none;
            position: fixed;
            right: 0;
            bottom: 0;
            background: var(--mint);
            color: #000;
            border: none;
            border-top: 3px solid var(--mint-outline);
            border-left: 3px solid var(--mint-outline);
            border-top-left-radius: 12px;
            width: 56px;
            height: 56px;
            font-size: 22px;
            cursor: pointer;
            z-index: 1000;
        }
        .toast {
            position: fixed;
            right: 18px;
            bottom: 18px;
            background: #111;
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            display: none;
        }
        #loadingScreen {
            position: fixed;
            inset: 0;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            transition: opacity .3s ease;
        }
        #loadingScreen.fadeOut {
            opacity: 0;
            pointer-events: none;
        }
        .spinner {
            width: 56px;
            height: 56px;
            border: 5px solid #ddd;
            border-top: 5px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0); }
            100% { transform: rotate(360deg); }
        }
        #errorFrame {
            position: fixed;
            inset: 0;
            border: 0;
            width: 100%;
            height: 100%;
            z-index: 6000;
            opacity: 0;
            transition: opacity .3s ease;
            display: none;
        }
        #errorFrame.visible {
            display: block;
            opacity: 1;
        }
        #docsModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.6);
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity .25s ease;
        }
        #docsModal.show {
            display: flex;
            opacity: 1;
        }
        #docsModal.hide {
            opacity: 0;
            transition: opacity .25s ease;
        }
        #docsWrapper {
            position: relative;
            animation: fadeIn .3s ease;
        }
        #docsWrapper.closing {
            animation: fadeOut .3s ease;
        }
        #docsWrapper iframe {
            width: 90vw;
            height: 85vh;
            border: 0;
            border-radius: 10px;
            background: #fff;
        }
        #closeDocs {
            position: absolute;
            top: 8px;
            right: 12px;
            background: rgba(255,255,255,0.85);
            border: none;
            font-size: 24px;
            cursor: pointer;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #111;
        }
        #closeDocs:hover {
            background: #fff;
        }
        #notesPopup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.6);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        #notesBox {
            background: #fff;
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow: auto;
            position: relative;
            animation: fadeIn .3s ease;
            display: flex;
            flex-direction: column;
        }
        #notesTitleBar {
            background: #f2f2f2;
            padding: 10px 14px;
            font-weight: 600;
            border-bottom: 1px solid #ddd;
        }
        #notesContent {
            padding: 16px;
        }
        #closeNotes {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(255,255,255,0);
            border: none;
            font-size: 24px;
            cursor: pointer;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #111;
        }
        @keyframes fadeIn {
            from { transform: scale(.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes fadeOut {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(.95); opacity: 0; }
        }
        @media (max-width:900px) {
            .container {
                flex-direction: column;
                overflow-x: hidden;
            }
            .header {
                min-width: auto;
            }
            .sidebar {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                border-left: 0;
                border-top: 1px solid var(--border);
                padding: 12px;
                max-height: 80vh;
            }
            .toggle-comments {
                display: block;
            }
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0d1117;
                --panel: #161b22;
                --muted: #9ca3af;
                --accent: #58a6ff;
                --border: #30363d;
                --mint: #065f46;
                --mint-outline: #10b981;
            }
            html, body {
                background: var(--bg);
                color: #f0f6fc;
            }
            .header {
                background: var(--panel);
                border-bottom: 1px solid var(--border);
            }
            .back {
                border: 1px solid var(--border);
                color: var(--accent);
            }
            select.builds {
                background: var(--panel);
                color: #f0f6fc;
                border: 1px solid var(--border);
            }
            .panel {
                background: var(--panel);
                border-bottom: 1px solid var(--border);
                color: #f0f6fc;
            }
            .sidebar {
                background: var(--panel);
                border-left: 1px solid var(--border);
            }
            .preview {
                border: 1px solid var(--border);
            }
            .toast {
                background: #f0f6fc;
                color: #000;
            }
            #loadingScreen {
                background: var(--panel);
            }
            .spinner {
                border: 5px solid #444;
                border-top: 5px solid var(--accent);
            }
            #docsModal {
                background: rgba(0,0,0,.8);
            }
            #docsWrapper iframe {
                background: var(--panel);
            }
            #closeDocs, #closeNotes {
                background: rgba(40,40,40,0.85);
                color: #f0f6fc;
            }
            #closeDocs:hover, #closeNotes:hover {
                background: #444;
            }
            #notesBox {
                background: var(--panel);
            }
            #notesTitleBar {
                background: #1f2937;
                border-bottom: 1px solid var(--border);
                color: #f0f6fc;
            }
            #codeBlock {
                filter: invert(100%);
                background: #E9E4DD !important;
            }
        }
    </style>
</head>
<body>
    <div id="loadingScreen">
        <div class="spinner"></div>
    </div>
    <div class="app">
        <header class="header">
            <div class="left-head">
                <a class="back" href="/">← Show more extensions</a>
                <div style="display:flex;align-items:center;gap:8px">
                    <!-- <div class="ext-title" id="extTitle">
                        Loading
                        <span class="ext-id" id="extID"></span>
                    </div> -->
                    <svg class="wip-icon" id="wipIcon" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
                        <path d="M12 2l9 21H3z" />
                        <path d="M12 9v5" />
                        <circle cx="12" cy="17" r="1" />
                    </svg>
                </div>
            </div>
            <div class="meta-btns" id="metaBtns">
                <select class="builds" id="buildSelect" style="display:none"></select>
                <a class="back" id="viewDocs" href="#" rel="noopener">Docs</a>
                <a class="back" id="copyLinkBtn" rel="noopener">Copy Link</a>
                <a class="back" id="shareBtn" href="#" rel="noopener">Share</a>
                <a class="back" id="copyCodeBtn">Copy Code</a>
                <!-- <a class="back" id="openBTN" href="#" rel="noopener">Try extension</a> -->
                 <a class="back" id="openBTN" href="#" target="_blank">Try extension</a>
                <a class="back" id="showNotesBtn" style="display:none">Show Notes</a>
            </div>
        </header>
        <div class="container">
            <main class="main" id="main" style="overflow: hidden;">
                <section class="panel">
                    <div class="ext-title" style="display:inline;" id="extTitle">Extension</div>: <div id="extDesc" style="display:inline;" style="color:var(--muted);font-size:14px"></div>
                </section>
                <section class="panel nopadding">
                    <div class="code-wrap" id="codeWrap">
                        <pre><code id="codeBlock" class="language-javascript"></code></pre>
                    </div>
                </section>
                <section class="panel">
                    <div class="preview" id="previewDIV">
                        <iframe id="previewFrame" title="Extension preview"></iframe>
                    </div>
                </section>
            </main>
            <aside class="sidebar hidden" id="commentsPane">
                <div class="panel">
                    <h3>Comments</h3>
                    <div id="giscusContainer"></div>
                </div>
            </aside>
        </div>
        <button id="toggleComments" class="toggle-comments">C</button>
    </div>
    <div id="docsModal">
        <div id="docsWrapper">
            <button id="closeDocs">×</button>
            <iframe id="docsFrame"></iframe>
        </div>
    </div>
    <div id="notesPopup">
        <div id="notesBox">
            <div id="notesTitleBar">Notes</div>
            <button id="closeNotes">×</button>
            <div id="notesContent"></div>
        </div>
    </div>
    <div class="toast" id="toast">Copied</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script>
        const codeBlock = document.getElementById('codeBlock'),
        codeWrap = document.getElementById('codeWrap'),
        titleEl = document.getElementById('extTitle'),
        openEl = document.getElementById('openBTN'),
        // idEl = document.getElementById('extID'),
        descEl = document.getElementById('extDesc'),
        wipIcon = document.getElementById('wipIcon'),
        showNotesBtn = document.getElementById('showNotesBtn'),
        buildSelect = document.getElementById('buildSelect'),
        viewDocs = document.getElementById('viewDocs'),
        copyCodeBtn = document.getElementById('copyCodeBtn'),
        copyLinkBtn = document.getElementById('copyLinkBtn'),
        shareBtn = document.getElementById('shareBtn'),
        toast = document.getElementById('toast'),
        commentsPane = document.getElementById('commentsPane'),
        giscusContainer = document.getElementById('giscusContainer'),
        toggleBtn = document.getElementById('toggleComments'),
        loadingScreen = document.getElementById('loadingScreen'),
        docsModal = document.getElementById('docsModal'),
        docsFrame = document.getElementById('docsFrame'),
        closeDocs = document.getElementById('closeDocs'),
        notesPopup = document.getElementById('notesPopup'),
        notesContent = document.getElementById('notesContent'),
        closeNotes = document.getElementById('closeNotes');
        // document.getElementById('previewDIV').style.maxHeight = "0px";

        function showToast(m) {
            toast.textContent = m;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 1600);
        }
        async function copyText(t) {
            try { await navigator.clipboard.writeText(t); showToast('Copied'); } catch {}
        }
        function handleResize() {
            if (innerWidth <= 900) {
                commentsPane.classList.add('hidden');
                commentsPane.classList.remove('visible');
                toggleBtn.style.display = 'block';
            } else {
                commentsPane.classList.remove('hidden', 'visible');
                toggleBtn.style.display = 'none';
            }
        }
        toggleBtn.onclick = () => {
            commentsPane.classList.toggle('visible');
            commentsPane.classList.toggle('hidden');
        };
        addEventListener('resize', handleResize);
        handleResize();
        copyCodeBtn.onclick = e => { e.preventDefault(); copyText(codeBlock.textContent); };
        copyLinkBtn.onclick = e => { e.preventDefault(); copyText(copyLinkBtn.href); };
        shareBtn.onclick = e => { e.preventDefault(); share(shareBtn.href); };
        showNotesBtn.onclick = () => { notesPopup.style.display = 'flex'; };
        closeNotes.onclick = () => { notesPopup.style.display = 'none'; };
        viewDocs.onclick = e => { e.preventDefault(); docsModal.classList.add('show'); };
        // openEl.onclick = e => { e.preventDefault(); document.getElementById('main').scrollTo({ top: document.getElementById('main').scrollHeight, behavior: 'smooth' }); };
        closeDocs.onclick = () => {
            const w = document.getElementById('docsWrapper');
            w.classList.add('closing');
            setTimeout(() => {
                docsModal.classList.remove('show');
                docsFrame.src = '';
                w.classList.remove('closing');
            }, 300);
        };
        function parseComments(t) {
            const lines = t.split('\n').filter(l => l.startsWith('//'));
            const d = {};
            for (const l of lines) {
                const m = l.match(/^\/\/\s*([^:]+):\s*(.*)$/);
                if (m) d[m[1].trim().toLowerCase()] = m[2].trim();
            }
            return d;
        }
        function getExtIdFromHash() {
            const h = location.hash.replace(/^#\//, '');
            return h.replace(/\/.*$/, '').replace(/\/$/, '');
        }
        function share(link) {
            var extid = getExtIdFromHash();
            try {
                navigator.share({
                    title: `${extid}`,
                    text: `Check out the ${extid} extension made by pooiod7`,
                    url: link
                }).catch(() => { navigator.clipboard.writeText(link); });
            } catch { navigator.clipboard.writeText(link); }
        }
        async function injectGiscus() {
            const s = document.createElement('script');
            s.src = 'https://giscus.app/client.js';
            s.setAttribute('data-repo', 'pooiod/ScratchExtensions');
            s.setAttribute('data-repo-id', 'R_kgDONUh5NA');
            s.setAttribute('data-category-id', 'DIC_kwDONUh5NM4Cwokk');
            s.setAttribute('data-mapping', 'title');
            s.setAttribute('data-reactions-enabled', '1');
            s.setAttribute('data-emit-metadata', '1');
            s.setAttribute('data-input-position', 'top');
            s.setAttribute('data-theme', 'preferred_color_scheme');
            s.setAttribute('data-lang', 'en');
            s.async = true;
            s.crossOrigin = 'anonymous';
            giscusContainer.appendChild(s);
            setTimeout(() => {
                if (!document.querySelector('iframe.giscus-frame')) {
                    commentsPane.style.display = 'none';
                    toggleBtn.style.display = 'none';
                }
            }, 7000);
        }
        async function loadExt() {
            const raw = location.hash.replace('#/', '');
            if (!raw) { showError('missing', 'NoExtension'); return; }
            const isDev = /\/dev\.js$/.test(raw);
            const name = raw.replace(/\/dev\.js$/, '').replace(/\/main\.js$/, '').replace(/\/$/, '');
            const build = isDev ? 'dev' : 'main';
            const fileUrl = `https://p7scratchextensions.pages.dev/ext/${name}/${build}.js`;
            const shareUrl = `https://p7scratchextensions.pages.dev/#/${name}`;
            document.title = name;
            try {
                const res = await fetch(fileUrl);
                const text = await res.text();
                if (!res.ok || text.includes('62478319')) {
                    showError('404', name, fileUrl);
                    return;
                }
                const info = parseComments(text);
                titleEl.textContent = info.name || name;
                // idEl.textContent = info.id ? `#${info.id}` : '';
                descEl.textContent = info.description || '';
                if ((info.wip || '').toLowerCase() === 'true') wipIcon.style.display = 'inline-block';
                if (info.docs) {
                    docsFrame.src = info.docs.startsWith('http') ? info.docs : `https://p7scratchextensions.pages.dev${info.docs}`;
                } else viewDocs.style.display = 'none';
                if (info.notes) {
                    showNotesBtn.style.display = 'inline-block';
                    notesContent.innerHTML = info.notes;
                }
                const builds = (info.builds || 'main').split(/\s+/).filter(x => x);
                if (builds.length > 1) {
                    buildSelect.style.display = 'inline-block';
                    builds.forEach(b => {
                        const o = document.createElement('option');
                        o.value = b;
                        o.textContent = b + (b === build ? ' (current)' : '');
                        buildSelect.appendChild(o);
                    });
                    buildSelect.onchange = () => {
                        location.hash = `#/${name}/${buildSelect.value}.js`;
                        location.reload();
                    };
                }
                codeBlock.textContent = text;
                hljs.highlightElement(codeBlock);
                const targetLine = text.split('\n').findIndex(l => /function\s*\(\s*Scratch\s*\)\s*\{/.test(l));
                if (targetLine >= 0) setTimeout(() => { codeWrap.scrollTop = targetLine * 18; }, 100);
                document.getElementById('previewFrame').textConetnt = `https://extensiontester.pooiod7.workers.dev/editor.html?extension=https://p7scratchextensions.pages.dev/ext/${name}/${build}.js`;
                copyLinkBtn.href = fileUrl;
                openEl.href = `/view/compile?ext=/ext/${name}/${build}.js`;
                shareBtn.href = shareUrl;
                viewDocs.href = docsFrame.src;
                injectGiscus();
                commentsPane.style.display = '';
                loadingScreen.classList.add('fadeOut');
                setTimeout(() => loadingScreen.remove(), 300);
            } catch { showError('404', name, fileUrl); }
        }
        window.showIFrame = () => {
            document.getElementById('previewFrame').src = document.getElementById('previewFrame').textConetnt;
            document.getElementById('previewFrame').addEventListener("load", () => {
                setTimeout(() => {
                    document.getElementById('previewFrame').style.opacity = "100%";
                }, 500);
            });;
        }
        var goingdothing9842 = false;
        document.getElementById('main').addEventListener('scroll',function(){
            if (goingdothing9842) return;
            if(this.scrollTop/(this.scrollHeight-this.clientHeight)>=0.5) {
                goingdothing9842 = true;
                showIFrame();
            }
        })
        function showError(type, id, path) {
            const f = document.createElement('iframe');
            f.id = 'errorFrame';
            f.src = `/404.html?type=extview&id=${encodeURIComponent(id)}&path=${encodeURIComponent(path || '')}&current=${encodeURIComponent(location.href)}`;
            f.style.position = 'fixed';
            f.style.inset = '0';
            f.style.border = '0';
            f.style.width = '100%';
            f.style.height = '100%';
            f.style.zIndex = '6000';
            f.style.opacity = '0';
            f.style.transition = 'opacity .3s ease';
            document.body.appendChild(f);
            setTimeout(() => { f.classList.add('visible'); f.style.opacity = '1'; }, 300);
            loadingScreen.classList.add('fadeOut');
            setTimeout(() => loadingScreen.remove(), 300);
            document.querySelector('.app').style.display = 'none';
        }
        loadExt();
    </script>
</body>
</html>
